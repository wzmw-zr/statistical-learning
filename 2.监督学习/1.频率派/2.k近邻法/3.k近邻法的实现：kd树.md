# k近邻法的实现：kd树

1. 实现k近邻法时，主要考虑的问题是如何对训练数据进行快速k近邻搜索。这点在特征空间的维数大及训练数据容量大时尤其重要。

2. k近邻法最简单的实现方法是线性扫描(linear scan)。这是要计算输入实例与每一个训练实例的距离，当训练集很大时，计算非常耗时，这种方法是不可行的。

3. 为了提高k近邻搜索的效率，可以考虑使用特殊的结构存储训练数据，以减少计算距离的次数，主要有：K-D Tree。




## 一、构造kd树

1. + kd树(k-dimension tree)是一种对k维空间中的实例点进行存储以便于对其进行快速检索的树形数据结构。

   + kd树是二叉树，表示对k维空间的一个划分。
   + 构造kd树相当于**不断地用垂直于坐标轴的超平面将k维空间切分**，构成一系列的k伟超矩形区域。
   + kd树中的**每个节点对应于一个k维超矩形区域**。

2. **构造平衡kd树的算法**：

   + **输入**：k维空间数据集$T=\{x_1,x_2,...x_N\}$，其中$x_i=(x_i^{(1)},x_i^{(2)},...x_i^{(k)})^T，i=1,2,...N$。

   + **输出**：kd树。

   + 1. 构造根结点，根节点对应于包含T的k维空间的超矩形区域。

        选择$x^{(1)}$为坐标轴，以T中所有实例的$x^{(1)}$坐标的中位数为切分点，将根节点对应的超矩形区域切分为两个子区域。且分通过切分点并与坐标轴$x^{(1)}$垂直的超平面实现。

        由根节点生成深度为1的左右子节点：**左子节点对应坐标$x^{(1)}$小于切分点的子区域，右子节点对应于坐标$x^{(1)}$大于切分点的子区域。**

        **将落在切分超平面上的实例点保存在根节点。**

     2. 重复：对深度为j的节点，选择$x^{(l)}$为切分的坐标轴，$l=j(\mod k)+1$，以该节点的区域中所有实例的$x^{(l)}$的中位数为切分点，将该节点对应的超矩形区域切分为两个子区域。切分由通过切分点并与坐标轴$x^{(l)}$垂直的超平面实现。

        由该节点生成深度为$j+1$的左右子节点：左子节点对应坐标$x^{(l)}$小于切分点的子区域，右子节点对应于坐标$x^{(l)}$大于切分点的子区域。

        将落在切分超平面上的实例点保存在该节点。

     3. 直到两个子区域没有实例点存在时停止。从而形成kd树的区域划分。



## 二、搜索kd树

1. 给定一个目标点，搜索其近邻。**首先找到包含目标点的叶节点;** 然后**从该叶节点出发，依次回退到父节点; 不断查找与目标点最邻近的节点**，当确定不可能存在更近的节点时终止。这样搜索就被限制在局部区域上，效率大为提高。

2. + 包含目标点的叶节点对应包含目标点的最小超矩形区域。

   + 以此叶节点的实例点作为当前最近点。**目标点的最近邻一定在以目标点为中心并通过当前最近点的超球形体的内部**。

   + 然后返回当前节点的父节点。

     **如果父节点的另一个子节点的超矩形与超球体相交，那么在相交区域内寻找与目标点更近的实例点。**

     如果存在这样的实例点，将此点作为新的当前最近点。算法转到更上一级的父节点，继续上述过程。

     如果父节点的另一子节点的超矩形区域与超球体不相交，或不存在比当前最近点更近的节点，则停止搜索。

3. **用kd树的最临近搜索**：

   + **输入：**已构造的kd树，目标点x。

   + **输出**：x的最近邻。

   + 1. 在kd树中找到包含目标点x的叶节点，从根节点出发，递归地向下访问kd树。

        若目标点x当前维的坐标小于切分点的目标，则移动到左子节点，否则移动到右子节点，直到子节点为叶节点为止。

     2. 以此叶节点为“当前最近点”。

     3. 递归地向上回退，在每个节点进行如下工作：

        + **如果该节点保存的实例点比当前最近点距离目标点更近，则以该节点作为“当前最近点”**。

        + **当前最近点一定存在于该节点一个子节点对应的区域**。检查该子节点的父节点的另一个子节点的对应区域是否有更近的点。

          具体地，**检查另一子节点对应的区域是否与以目标点为球心，以目标点与“当前最近点”间的距离为半径的超球体相交。**

          如果相交，可能在另一个子节点对应的区域内存在距目标点更近的点，移动到另一个子节点，接着递归地进行最近邻搜索。

          如果不相交，向上回退。

        + 当回退到根节点时，搜索结束。最后的“当前最近点”就是x的最临近点。

4. kd树搜索的平均计算复杂度是$O(\log N)$，这里N是训练实例数，**kd树适合用于训练实例数远大于空间维数的k近邻搜索。**当空间维数接近训练实例数时，它的效率会迅速下降，几乎接近线性扫描。